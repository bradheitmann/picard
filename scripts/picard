#!/usr/bin/env python3
"""
ğŸ–– PICARD - Project Intelligence, Coordination, And Resource Deployment
Production-grade multi-agent orchestration command center
"Make it so."
"""

import sqlite3
import json
import sys
import time
from pathlib import Path
from datetime import datetime, timedelta
from rich.console import Console
from rich.live import Live
from rich.layout import Layout
from rich.panel import Panel
from rich.table import Table
from rich.text import Text
from rich.align import Align
from rich.columns import Columns
from rich import box
from rich.progress import Progress, BarColumn, TextColumn, SpinnerColumn

# Paths
DEV_HOME = Path.home() / ".dev"
DB_PATH = DEV_HOME / "logs/observability.db"
EVENTS_STREAM = DEV_HOME / "logs/events/global-stream.jsonl"

console = Console()

# ASCII Art
PICARD_BANNER = r"""
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
    â•šâ•â•     â•šâ•â• â•šâ•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•

    ğŸ–– Project Intelligence, Coordination, And Resource Deployment ğŸ––
                        "Make It So"
"""

class Picard:
    def __init__(self):
        if not DB_PATH.exists():
            console.print("[red]âœ— Database not initialized[/red]")
            console.print(f"\nRun: sqlite3 {DB_PATH} < ~/.dev/observability/schema.sql")
            sys.exit(1)

        self.conn = sqlite3.connect(str(DB_PATH), check_same_thread=False)

    def get_agents_by_role(self):
        """Get agents grouped by specialization/role"""
        cursor = self.conn.cursor()
        cursor.execute("""
            SELECT
                a.agent_id,
                a.agent_name,
                a.platform,
                a.agent_type,
                a.status,
                COUNT(DISTINCT t.task_id) as active_tasks,
                a.total_tasks_completed,
                a.total_tasks_failed
            FROM agents a
            LEFT JOIN tasks t ON a.agent_id = t.agent_id
                AND t.status IN ('claimed', 'in_progress')
            WHERE a.status IN ('active', 'idle', 'busy')
            GROUP BY a.agent_id
            ORDER BY a.agent_type, a.status DESC
        """)
        return cursor.fetchall()

    def get_roi_metrics(self):
        """Calculate ROI metrics"""
        cursor = self.conn.cursor()

        # Tasks completed vs cost
        cursor.execute("""
            SELECT
                COUNT(DISTINCT t.task_id) as tasks_completed,
                SUM(tu.total_tokens) as total_tokens,
                SUM(tu.cost_usd) as total_cost,
                SUM(t.lines_added) as total_lines,
                SUM(t.files_modified) as total_files
            FROM tasks t
            LEFT JOIN token_usage tu ON t.task_id = tu.task_id
            WHERE DATE(t.completed_at) = DATE('now')
                AND t.outcome = 'success'
        """)
        row = cursor.fetchone()

        return {
            'tasks_completed': row[0] or 0,
            'total_tokens': row[1] or 0,
            'total_cost': row[2] or 0.0,
            'lines_delivered': row[3] or 0,
            'files_delivered': row[4] or 0,
            'cost_per_task': (row[2] / row[0]) if row[0] > 0 else 0.0,
            'lines_per_dollar': (row[3] / row[2]) if row[2] and row[2] > 0 else 0
        }

    def get_context_usage(self):
        """Get context window usage by agent"""
        cursor = self.conn.cursor()
        cursor.execute("""
            SELECT
                agent_id,
                AVG(input_tokens) as avg_input,
                MAX(input_tokens) as max_input,
                context_window
            FROM token_usage
            WHERE datetime(timestamp) > datetime('now', '-1 hour')
            GROUP BY agent_id
            ORDER BY avg_input DESC
        """)
        return cursor.fetchall()

    def get_team_performance(self):
        """Get performance by team"""
        cursor = self.conn.cursor()
        cursor.execute("""
            SELECT
                t.team_id,
                COUNT(DISTINCT ts.agent_id) as team_size,
                COUNT(DISTINCT ts.task_id) as tasks_completed,
                AVG(ts.duration_ms) / 1000.0 as avg_task_time_sec
            FROM teams t
            LEFT JOIN tasks ts ON t.team_id = ts.team_id
            WHERE ts.completed_at > datetime('now', '-24 hours')
                AND ts.outcome = 'success'
            GROUP BY t.team_id
        """)
        return cursor.fetchall()

    def get_quality_gates(self):
        """Check quality gate status"""
        cursor = self.conn.cursor()

        # Check recent task success rate
        cursor.execute("""
            SELECT
                CAST(SUM(CASE WHEN outcome = 'success' THEN 1 ELSE 0 END) AS FLOAT) /
                COUNT(*) as success_rate
            FROM tasks
            WHERE completed_at > datetime('now', '-1 hour')
        """)
        success_rate = cursor.fetchone()[0] or 0.0

        # Check error rate
        cursor.execute("""
            SELECT
                CAST(COUNT(CASE WHEN event_type LIKE '%.failed' THEN 1 END) AS FLOAT) /
                COUNT(*) as error_rate
            FROM events
            WHERE timestamp > datetime('now', '-1 hour')
        """)
        error_rate = cursor.fetchone()[0] or 0.0

        return {
            'success_rate': success_rate,
            'error_rate': error_rate,
            'quality_passing': success_rate > 0.8 and error_rate < 0.15
        }

def create_header():
    """Create PICARD header with ASCII art"""
    header_text = Text()
    header_text.append(PICARD_BANNER, style="bold cyan")
    header_text.append("\n")
    header_text.append("Real-Time Agent Orchestration & Observability", style="dim italic", justify="center")

    return Panel(
        Align.center(header_text),
        box=box.DOUBLE_EDGE,
        border_style="bright_cyan",
        padding=(0, 2)
    )

def create_agents_panel(picard):
    """Create agents panel with role grouping"""
    agents = picard.get_agents_by_role()

    table = Table(box=box.SIMPLE_HEAVY, border_style="green", show_header=True, header_style="bold green")
    table.add_column("Agent", style="cyan", no_wrap=True)
    table.add_column("Role", style="magenta")
    table.add_column("Platform", style="blue")
    table.add_column("Status", justify="center")
    table.add_column("Active", justify="right")
    table.add_column("Done", justify="right", style="green")
    table.add_column("Fail", justify="right", style="red")

    for agent in agents:
        agent_id, agent_name, platform, agent_type, status, active, completed, failed = agent

        # Status with emoji
        status_display = {
            'active': '[green]ğŸŸ¢ ACTIVE[/green]',
            'idle': '[yellow]ğŸŸ¡ IDLE[/yellow]',
            'busy': '[blue]ğŸ”µ BUSY[/blue]',
            'error': '[red]ğŸ”´ ERROR[/red]'
        }.get(status, f'âšª {status}')

        # Role display
        role_display = {
            'assistant': 'ğŸ¤– Assistant',
            'specialist': 'âš¡ Specialist',
            'coordinator': 'ğŸ¯ Coordinator',
            'reviewer': 'ğŸ‘€ Reviewer'
        }.get(agent_type, agent_type or 'General')

        table.add_row(
            agent_name[:20] if agent_name else agent_id[:20],
            role_display,
            platform or "â€”",
            status_display,
            str(active),
            str(completed or 0),
            str(failed or 0)
        )

    return Panel(table, title="[bold green]ğŸ¤– AGENT FLEET[/bold green]", border_style="green")

def create_roi_panel(picard):
    """Create ROI metrics panel"""
    roi = picard.get_roi_metrics()

    grid = Table.grid(padding=(0, 2))
    grid.add_column(justify="left", style="bold")
    grid.add_column(justify="right")

    grid.add_row("âœ… Tasks Completed:", f"[green]{roi['tasks_completed']}[/green]")
    grid.add_row("ğŸ“ Lines Delivered:", f"[cyan]{roi['lines_delivered']:,}[/cyan]")
    grid.add_row("ğŸ“ Files Modified:", f"[blue]{roi['files_delivered']}[/blue]")
    grid.add_row("ğŸ« Tokens Used:", f"[yellow]{roi['total_tokens']:,}[/yellow]")
    grid.add_row("ğŸ’° Cost (24h):", f"[magenta]${roi['total_cost']:.4f}[/magenta]")
    grid.add_row("ğŸ’µ Cost/Task:", f"[dim]${roi['cost_per_task']:.4f}[/dim]")

    if roi['lines_per_dollar'] > 0:
        grid.add_row("ğŸ“ˆ Lines/$:", f"[green bold]{roi['lines_per_dollar']:.0f}[/green bold]")

    return Panel(grid, title="[bold yellow]ğŸ’° ROI METRICS (24H)[/bold yellow]", border_style="yellow")

def create_context_panel(picard):
    """Create context management panel"""
    context_data = picard.get_context_usage()

    if not context_data:
        return Panel(
            "[dim]No context data yet[/dim]",
            title="[bold blue]ğŸ§  CONTEXT MANAGEMENT[/bold blue]",
            border_style="blue"
        )

    table = Table(box=box.SIMPLE, show_header=True, header_style="bold blue")
    table.add_column("Agent", style="cyan")
    table.add_column("Avg Tokens", justify="right")
    table.add_column("Max Tokens", justify="right")
    table.add_column("Window", justify="right")
    table.add_column("Usage %", justify="right")

    for row in context_data:
        agent_id, avg_input, max_input, context_window = row
        usage_pct = (avg_input / context_window * 100) if context_window else 0

        # Color code usage
        if usage_pct > 80:
            usage_display = f"[red]{usage_pct:.0f}%[/red]"
        elif usage_pct > 60:
            usage_display = f"[yellow]{usage_pct:.0f}%[/yellow]"
        else:
            usage_display = f"[green]{usage_pct:.0f}%[/green]"

        table.add_row(
            agent_id[:15],
            f"{avg_input:.0f}",
            f"{max_input:.0f}",
            str(context_window or "â€”"),
            usage_display
        )

    return Panel(table, title="[bold blue]ğŸ§  CONTEXT MANAGEMENT[/bold blue]", border_style="blue")

def create_quality_gates_panel(picard):
    """Create quality gates status panel"""
    gates = picard.get_quality_gates()

    grid = Table.grid(padding=(0, 1))
    grid.add_column(justify="left")
    grid.add_column(justify="right")

    # Success rate
    success_pct = gates['success_rate'] * 100
    if success_pct >= 80:
        success_display = f"[green bold]{success_pct:.1f}%[/green bold]"
    elif success_pct >= 60:
        success_display = f"[yellow]{success_pct:.1f}%[/yellow]"
    else:
        success_display = f"[red]{success_pct:.1f}%[/red]"

    grid.add_row("âœ… Success Rate:", success_display)

    # Error rate
    error_pct = gates['error_rate'] * 100
    if error_pct < 10:
        error_display = f"[green]{error_pct:.1f}%[/green]"
    elif error_pct < 20:
        error_display = f"[yellow]{error_pct:.1f}%[/yellow]"
    else:
        error_display = f"[red bold]{error_pct:.1f}%[/red bold]"

    grid.add_row("âŒ Error Rate:", error_display)

    # Overall status
    if gates['quality_passing']:
        status = "[green bold]âœ“ PASSING[/green bold]"
    else:
        status = "[red bold]âœ— FAILING[/red bold]"

    grid.add_row("", "")
    grid.add_row("Quality Gates:", status)

    return Panel(grid, title="[bold magenta]ğŸ¯ QUALITY GATES[/bold magenta]", border_style="magenta")

def create_tasks_panel(picard):
    """Create active tasks panel with priority"""
    tasks = picard.conn.cursor().execute("""
        SELECT task_id, task_name, assigned_agent_id, status, priority
        FROM task_queue
        WHERE status IN ('pending', 'assigned', 'in_progress')
        ORDER BY
            CASE priority
                WHEN 'critical' THEN 1
                WHEN 'high' THEN 2
                WHEN 'medium' THEN 3
                ELSE 4
            END
        LIMIT 8
    """).fetchall()

    table = Table(box=box.SIMPLE, show_header=True, header_style="bold yellow")
    table.add_column("Task", style="cyan", no_wrap=False, max_width=35)
    table.add_column("Agent", style="blue", max_width=15)
    table.add_column("Status", justify="center")
    table.add_column("Priority")

    for task in tasks:
        task_id, task_name, agent_id, status, priority = task

        status_emoji = {
            'pending': 'â³',
            'assigned': 'ğŸ¯',
            'in_progress': 'âš¡'
        }.get(status, 'â“')

        priority_display = {
            'critical': '[red bold]ğŸ”¥ CRIT[/red bold]',
            'high': '[red]HIGH[/red]',
            'medium': '[yellow]MED[/yellow]',
            'low': '[dim]low[/dim]'
        }.get(priority, priority or 'med')

        table.add_row(
            task_name[:32] + "..." if len(task_name) > 35 else task_name,
            agent_id[:13] + "..." if agent_id and len(agent_id) > 15 else (agent_id or "[dim]â€”[/dim]"),
            f"{status_emoji} {status[:8]}",
            priority_display
        )

    if not tasks:
        return Panel("[dim italic]No active tasks[/dim italic]", title="[bold yellow]ğŸ“‹ TASK QUEUE[/bold yellow]", border_style="yellow")

    return Panel(table, title="[bold yellow]ğŸ“‹ TASK QUEUE[/bold yellow]", border_style="yellow")

def create_teams_panel(picard):
    """Create team performance panel"""
    teams = picard.get_team_performance()

    if not teams:
        return Panel(
            "[dim italic]No teams active[/dim italic]",
            title="[bold cyan]ğŸ‘¥ TEAMS[/bold cyan]",
            border_style="cyan"
        )

    grid = Table.grid(padding=(0, 2))
    grid.add_column(justify="left", style="bold cyan")
    grid.add_column(justify="right")

    for team in teams:
        team_id, size, tasks, avg_time = team
        grid.add_row(
            f"ğŸ‘¥ {team_id}:",
            f"{size} agents, {tasks} tasks, {avg_time:.1f}s avg"
        )

    return Panel(grid, title="[bold cyan]ğŸ‘¥ TEAM PERFORMANCE[/bold cyan]", border_style="cyan")

def create_events_stream_panel(picard):
    """Create live event stream"""
    # Get last 6 events
    events = picard.conn.cursor().execute("""
        SELECT timestamp, agent_id, event_type, project
        FROM events
        ORDER BY id DESC
        LIMIT 6
    """).fetchall()

    lines = []
    for event in events:
        timestamp, agent_id, event_type, project = event
        try:
            dt = datetime.fromisoformat(timestamp.replace('Z', '+00:00'))
            time_str = dt.strftime("%H:%M:%S")
        except:
            time_str = "??:??:??"

        event_emoji = {
            'agent.started': 'ğŸŸ¢',
            'agent.stopped': 'ğŸ”´',
            'agent.deployed': 'ğŸš€',
            'task.claimed': 'ğŸ¯',
            'task.completed': 'âœ…',
            'task.failed': 'âŒ',
            'action.file_write': 'ğŸ“',
            'action.bash_command': 'âš™ï¸',
            'conflict.detected': 'âš ï¸'
        }.get(event_type, 'ğŸ“')

        lines.append(f"{time_str} {event_emoji} [{agent_id[:12]}] {event_type}")

    content = "\n".join(lines) if lines else "[dim]Waiting for events...[/dim]"

    return Panel(content, title="[bold blue]ğŸ“Š LIVE EVENT STREAM[/bold blue]", border_style="blue", height=10)

def create_layout():
    """Create dashboard layout"""
    layout = Layout()

    layout.split_column(
        Layout(name="header", size=11),
        Layout(name="main"),
        Layout(name="footer", size=3)
    )

    layout["main"].split_row(
        Layout(name="left", ratio=2),
        Layout(name="right", ratio=1)
    )

    layout["left"].split_column(
        Layout(name="agents", ratio=2),
        Layout(name="tasks", ratio=1)
    )

    layout["right"].split_column(
        Layout(name="roi", size=12),
        Layout(name="context", size=10),
        Layout(name="quality", size=10),
        Layout(name="events")
    )

    return layout

def render_dashboard(picard):
    """Render complete dashboard"""
    layout = create_layout()

    # Header
    layout["header"].update(create_header())

    # Main panels
    layout["agents"].update(create_agents_panel(picard))
    layout["tasks"].update(create_tasks_panel(picard))
    layout["roi"].update(create_roi_panel(picard))
    layout["context"].update(create_context_panel(picard))
    layout["quality"].update(create_quality_gates_panel(picard))
    layout["events"].update(create_events_stream_panel(picard))

    # Footer
    footer = Text()
    footer.append(f"Last Update: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}", style="dim")
    footer.append("  |  ", style="dim")
    footer.append("DB: ", style="dim")
    footer.append(str(DB_PATH), style="cyan dim")
    footer.append("  |  Press ", style="dim")
    footer.append("Ctrl+C", style="bold red")
    footer.append(" to exit", style="dim")

    layout["footer"].update(Panel(Align.center(footer), border_style="dim"))

    return layout

def main():
    """Main entry point"""
    picard = Picard()

    console.print("[green]ğŸ–– PICARD initializing...[/green]\n")
    time.sleep(0.5)

    try:
        with Live(render_dashboard(picard), refresh_per_second=1, screen=True) as live:
            while True:
                live.update(render_dashboard(picard))
                time.sleep(1.0)
    except KeyboardInterrupt:
        console.print("\n\n[green]âœ“ PICARD standing down. Make it so.[/green]")
        picard.conn.close()
    except Exception as e:
        console.print(f"\n[red]âœ— Error: {e}[/red]")
        picard.conn.close()
        sys.exit(1)

if __name__ == "__main__":
    main()
